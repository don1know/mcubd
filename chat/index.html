<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
</head>
 
<body>
  <button class="his" id="his" onclick="loadHis()">History</button>
  <h5 id="h5"></h5>
  <ul id="messages"></ul>

  <form id="form" action="">
    <input id="input" placeholder="Type..." autocomplete="off" /><button>

      <div style="background:url(send.svg)"></div>



    </button>
  </form>





  <script>
    var messages = document.getElementById('messages');
    var form = document.getElementById('form');


    form.addEventListener('submit', function (e) {
      e.preventDefault();
      if (input.value) {
        //   socket.emit('chat message', input.value);
        dbsend(input.value)
        // input.value = '';
      }
    });


    // ---------------get

  
    function get() {
      var xhttp = new XMLHttpRequest();
      xhttp.open("GET", 'https://nodebd.vercel.app/chatdata', true);
      xhttp.onload = function () {

        if (this.responseText == [] || this.responseText == '[]') {

          document.getElementById('h5').innerText = '0 data in collection'

        } else {
          const arr = JSON.parse(this.responseText)
          const obj = arr[0]


          print(obj)

        }
      }
      xhttp.send();
    }; get()

    function copy(ele) {
      console.log('copied:'+ ele.parentElement.firstChild.innerText)
      navigator.clipboard.writeText(ele.parentElement.firstChild.innerText)

      
      ele.children[0].stop()

      setTimeout(() => {
      ele.children[0].play()
        
      }, 4000);
    }

    var print = async function (obj, hisprint) {

      var node = document.createElement('li')
      var num = document.createElement('span')
      var ip = document.createElement('span')
      var txt = document.createElement('span')
      var time = document.createElement('span')
      var copy = document.createElement('button')
      var copylogo = document.createElement('lottie-player')


      copy.setAttribute("class", "copy")
      copy.setAttribute("onClick", "copy(this)")
      copylogo.setAttribute("src", "https://assets6.lottiefiles.com/packages/lf20_niqylzi0.json")
      copylogo.setAttribute("background", "transparent")
      copylogo.setAttribute("speed", "3")
      copylogo.setAttribute("id", "copylogo")
      copylogo.setAttribute("style", "width:30px; ")
      // copylogo.setAttribute("loop","true")
      copylogo.setAttribute("autoplay","true")
      ip.setAttribute("style", "float:right; ")
      
      txt.textContent = obj.data
      ip.textContent = ' '+'['+obj.ip+']'
      time.textContent = obj.date
      num.textContent = obj.num
      num.setAttribute("class", "block")
      copy.append(copylogo);
      node.append(txt,num, copy, time,ip);
      if (hisprint == 'hisprint') {
        console.log(messages.firstChild)
        messages.insertBefore(node,document.getElementById('messages').firstChild)
      document.getElementById('his').disabled = false
      } else {
        messages.appendChild(node);
      }
      // document.getElementById('copylogo').stop()


    }



    async function dbsend(msgdata) {
      let ram='not-found'
      let  device='not-found'
      let platform='not-found'
      if(window.navigator.deviceMemory){ram = navigator.deviceMemory}
      if(window.navigator.appVersion){device = navigator.appVersion}
      if(window.navigator.platform){platform =navigator.platform}

       
      var xhttp = new XMLHttpRequest();
      xhttp.open("POST", 'https://nodebd.vercel.app/chatdata', true);
      xhttp.onload = function () {
        const arr = JSON.parse(this.responseText);
        const obj=arr[0]
        if(obj.data==msgdata){

          print(obj)
         document.getElementById('input').value=''
 
        }
        else{
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')

        }

        
      }

      xhttp.send(JSON.stringify({
        "data": msgdata, "ram": ram
        , "device": device, "platform": platform
      }));

    }

    function loadHis() {
      document.getElementById('his').disabled = true
      var last = document.getElementById('messages')

      if (last.firstChild.children[1].innerText == 1) { alert('no more') } else {
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", 'https://nodebd.vercel.app/chatdatahis', true);

        xhttp.onload = function () {
          const obj = JSON.parse(this.responseText);
          if (this.responseText == '[]') { document.getElementById("h5").innerHTML = 'nai' } else {

            const arr = JSON.parse(this.responseText)
            const obj = arr[0]
            print(obj, 'hisprint')

          }
        }



        xhttp.send(last.firstChild.children[1].innerText);

      }
    }


    function neww() {
      var ul = document.getElementById('messages')
      // console.log(ul.lastChild.children[1].innerText)
      
      if(ul.lastChild){
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", 'https://nodebd.vercel.app/chatdatanew', true);

        xhttp.onload = function () {
          if (this.responseText == '[]' || this.responseText== []) { } else {
            const arr = JSON.parse(this.responseText);
            const obj =arr[0]
            console.log(obj)

            print(obj)

          }
        }

        xhttp.send(ul.lastChild.children[1].innerText);
      }else{
        
      }


  }


setInterval(() => { neww() }, 12000);








  </script>


<!-- <div style="" id="failed" class="failed">
  <lottie-player src="https://mcubd.netlify.app/logoimg/copy.json"
      background="transparent" speed="1" style=" height: 20px;" loop autoplay></lottie-player>
</div> -->

  <link href="1.css" rel="stylesheet">
  <script src="https://mcubd.netlify.app/lottie-player.js"></script>


</body>

</html>