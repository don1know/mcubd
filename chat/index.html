<!DOCTYPE html>
<html>

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
  <!-- <style>
     h5{
      display: inline-block;
      font-size: 7px;
     }
     li{
      font-size: 12px;
     }
     #input{
      position: fixed;
      bottom: 0;
      left: 0;
     }
     #but{
      position: fixed;
      bottom: 0;
      right: 0;
      padding: 15px 25px 15px 25px;
     }
    
    </style> -->
</head>

<body>
  <button class="his" id="his" onclick="loadHis()">History</button>
  <h5 id="h5"></h5>
  <ul id="messages"></ul>
  <form id="form" action="">
    <input id="input" autocomplete="off" /><button>Send</button>
  </form>
  <!-- <h1 id="h1"></h1> -->


  <!-- <button id="but" onclick="go()" >stop reloading</button> -->





  <script>
    var messages = document.getElementById('messages');
    var form = document.getElementById('form');


    form.addEventListener('submit', function (e) {
      e.preventDefault();
      if (input.value) {
        //   socket.emit('chat message', input.value);
        dbsend(input.value)
        // input.value = '';
      }
    });


    // ---------------get

    function get() {
      var xhttp = new XMLHttpRequest();
      xhttp.open("GET", 'https://nodebd.vercel.app/chatdata', true);
      xhttp.onload = function () {

        if (this.responseText == [] || this.responseText == '[]') {

          document.getElementById('h5').innerText = '0 data in collection'

        } else {
          const arr = JSON.parse(this.responseText)
          const obj = arr[0]


          print(obj)

        }
      }
      xhttp.send();
    }; get()

    function copy(ele) {
      console.log(ele.parentElement.firstChild.innerText)
      navigator.clipboard.writeText(ele.parentElement.firstChild.innerText)

      ele.style.backgroundColor = 'white'
    }

    var print = async function (obj, hisprint) {



      var node = document.createElement('li')
      var num = document.createElement('span')
      var txt = document.createElement('span')
      var time = document.createElement('span')
      var copy = document.createElement('button')
      copy.innerHTML = 'kk'
      copy.setAttribute("class", "copy")
      copy.setAttribute("onClick", "copy(this)")


      txt.textContent = obj.data + '-----' + obj.ip + '--'

      time.textContent = obj.date
      num.textContent = obj.num
      num.setAttribute("class", "block")

      node.append(txt, num, copy, time);
      if (hisprint == 'hisprint') {
        console.log(messages.firstChild)
        messages.insertBefore(node,document.getElementById('messages').firstChild)
      document.getElementById('his').disabled = false

        
      } else {
        messages.appendChild(node);

      }
    }



    async function dbsend(msgdata) {
      let ram='not-found'
      let  device='not-found'
      let platform='not-found'
      if(window.navigator.deviceMemory){ram = navigator.deviceMemory}
      if(window.navigator.appVersion){device = navigator.appVersion}
      if(window.navigator.platform){platform =navigator.platform}

       
      var xhttp = new XMLHttpRequest();
      xhttp.open("POST", 'https://nodebd.vercel.app/chatdata', true);
      xhttp.onload = function () {
        const arr = JSON.parse(this.responseText);
        const obj=arr[0]
        if(obj.data==msgdata){

          print(obj)
         document.getElementById('input').value=''
 
        }
        else{
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')
          alert('eror in dbsend/onload obj.data==msgdata')

        }

        
      }

      xhttp.send(JSON.stringify({
        "data": msgdata, "ram": ram
        , "device": device, "platform": platform
      }));

    }

    function loadHis() {
      document.getElementById('his').disabled = true
      var last = document.getElementById('messages')

      if (last.firstChild.children[1].innerText == 1) { alert('no more') } else {
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", 'https://nodebd.vercel.app/chatdatahis', true);

        xhttp.onload = function () {
          const obj = JSON.parse(this.responseText);
          if (this.responseText == '[]') { document.getElementById("h5").innerHTML = 'nai' } else {

            const arr = JSON.parse(this.responseText)
            const obj = arr[0]
            print(obj, 'hisprint')

          }
        }



        xhttp.send(last.firstChild.children[1].innerText);

      }
    }


    // function neww() {
    //   var las = document.getElementById('messages')
    //   var h11 = document.getElementById('h1')
    //   if (h11.innerHTML = 'nai') {

    //     var xhttp = new XMLHttpRequest();
    //     xhttp.open("GET", 'https://nodebd.vercel.app/his', true);

    //     xhttp.onload = function () {
    //       const obj = JSON.parse(this.responseText);
    //       if (this.responseText == '[]') { } else {
    //         var node = document.createElement('li')
    //         var h5 = document.createElement('h5')
    //         h5.textContent = obj[0].num
    //         node.textContent = obj[0].date + '-----' + obj[0].name + '-----' + obj[0].ipad + '--'
    //         node.appendChild(h5);
    //         las.append(node);
    //       }
    //     }

    //     xhttp.send();
    //   } else if (document.getElementById('messages').lastChild) {

    //     var mesg = document.getElementById('messages')
    //     var xhttp = new XMLHttpRequest();
    //     xhttp.open("GET", 'https://nodebd.vercel.app/his', true);
    //     xhttp.setRequestHeader('n', mesg.lastChild.lastChild.innerHTML)

    //     xhttp.onload = function () {
    //       const obj = JSON.parse(this.responseText);
    //       if (this.responseText == '[]') { } else {
    //         var node = document.createElement('li')
    //         var h5 = document.createElement('h5')
    //         h5.textContent = obj[0].num
    //         node.textContent = obj[0].date + '-----' + obj[0].name + '-----' + obj[0].ipad + '--'
    //         node.appendChild(h5);
    //         las.append(node);
    //       }
    //     }

    //     xhttp.send();

    //   } else if (h11.innerHTML = '') { } else { alert('what!!!') }

    // }







  </script>


<div style="display:none" id="failed" class="failed">
  <lottie-player src="\copy.json"
      background="transparent" speed="1" style=" height: 120px;" loop autoplay></lottie-player>

  <p id="sendtxt">Failed to send.Plz cheak ur internet connection or refresh the website</p>
</div>

  <link href="1.css" rel="stylesheet">
  <script src="http://mcubd.netlify.app/lottie-player.js"></script>


</body>

</html>